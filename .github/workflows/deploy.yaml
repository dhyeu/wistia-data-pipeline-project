# .github/workflows/deploy.yaml

# This is the name of your GitHub Actions workflow that will appear in the UI
name: Deploy Wistia Pipeline

# This defines when the workflow should run
on:
  push:
    # Configure the workflow to run on pushes to your primary branch
    # <<< IMPORTANT: Make sure this matches your primary branch name (e.g., main or master)
    branches:
      - main

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  deploy:
    # Configure the runner environment for this job
    runs-on: ubuntu-latest

    # Set permissions for the GITHUB_TOKEN to allow fetching the OIDC token for WIF
    permissions:
      contents: 'read' # Allows checking out the code
      id-token: 'write' # Allows fetching the OIDC token needed for GCP authentication

    # Steps define the sequence of tasks to be executed within the job
    steps:
    - name: Checkout Code # Step 1: Clone the repository code onto the runner VM
      uses: actions/checkout@v4 # Uses the official action to check out your repo

    - name: Authenticate to Google Cloud # Step 2: Authenticate using Workload Identity Federation
      id: 'auth' # Assign an ID to this step
      uses: 'google-github-actions/auth@v2' # Uses Google's official WIF authentication action
      with:
        # <<< Your actual GCP Project ID
        project_id: 'wistia-data-pipeline-project'

        # <<< Your FULL Workload Identity Provider ID from GCP
        # Format: projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID
        # Use the Project Number you retrieved (991483477222), Pool ID (github-actions-pool),
        # and the Provider ID that successfully created (gh-provider-1)
        workload_identity_provider: 'projects/991483477222/locations/global/workloadIdentityPools/github-actions-pool/providers/gh-provider-1'

        # <<< The email of the Service Account you created for CI/CD
        service_account: 'github-actions-pipeline-sa@wistia-data-pipeline-project.iam.gserviceaccount.com'

    - name: Set up gcloud CLI # Step 3: Install and configure the Google Cloud SDK CLI on the runner
      uses: 'google-github-actions/setup-gcloud@v2'
      with:
        version: 'latest' # Use the latest version of the gcloud CLI

    # --- Cloud Run Job Deployment Steps ---
    # Note: This assumes your Cloud Run Job code and Dockerfile are in a folder named 'cloud-run-job'
    - name: Build and Push Cloud Run Job Image # Step 4: Build & Push the Job Image via Cloud Build
      run: |-
        # Navigate to the directory containing your Cloud Run Job code and Dockerfile
        cd ./cloud-run-job/
        # Get the project ID from the authenticated gcloud configuration
        PROJECT_ID=$(gcloud config get-value project)
        # Define the full image name using Artifact Registry path
        # <<< IMPORTANT: 'wistia-pipeline-repo' must be an existing Artifact Registry repo in us-central1
        # If you haven't created it, run: gcloud artifacts repositories create wist